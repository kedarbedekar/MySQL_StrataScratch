-- Question 1
-- Write a query to return the customer_name, product_name, and total_amount for each sale in the last 30 days.
-- Tables used: Customers, Products and Sales

-- Solution:

SELECT
  c.customer_name,
  p.product_name,
  s.total_amount
FROM customers c
  JOIN sales s ON c.customer_id = s.customer_id
  JOIN products p ON s.product_id = p.product_id
WHERE DATEDIFF(CURRENT_DATE(), sale_date) <= 30
ORDER BY s.total_amount DESC;

-- Question 2
-- Write a query to find the total revenue generated by each product category in the last year. The output should include the product category and the total revenue for that category.
-- Tables used: Product and Sales

-- Solution:

SELECT
  p.category,
  SUM(tota_amount) AS Total_Revenue
FROM products p 
  JOIN sales s ON p.product_id = s.product_id
WHERE YEAR(sale_date) = 2023
GROUP BY p.category
ORDER BY Total_Revenue DESC;

-- Alternatively

SELECT
  p.category,
  SUM(total_amount) AS Total_Revenue
FROM products p 
  JOIN sales s ON p.product_id = s.product_id
WHERE sale_date BETWEEN '2023-01-01' AND '2023-12-31'
GROUP BY p.category
ORDER BY Total_Revenue DESC;


-- Question 3
-- Write a query to return all customers who made purchases in 2023 and are located in the "West" region.
-- Tables used: customers, sales

-- Solution:

SELECT

c.customer_id,
c.customer_name,
c.sales_region,
c.sign_up_date,
s.sale_date
FROM customers c 
  JOIN sales s ON c.customer_id = s.customer_id
WHERE sale_date BETWEEN '2023-01-01' AND '2023-12-31'
AND sales_region = 'West'

-- Question 4
-- Write a query to display the total number of sales, total quantity sold, and total revenue for each customer. 
-- The result should include the customer_name, total sales, total quantity, and total revenue.
-- Tables used: customers, sales

SELECT
  c.customer_name,
  COUNT(s.sales_id) AS total_sales,
  SUM(s.quantity) AS total_quantity,
  SUM(s.total_amount) AS total_revenue
FROM customers c
  JOIN sales s ON c.customer_id = s.customer_id
GROUP BY c.customer_name
ORDER BY total_revenue DESC;

-- Question 5
-- Write a query to find the top 3 customers (by total revenue) in the year 2023.
-- Tables used: customers, sales

-- Solution:

WITH cte AS (
SELECT
  c.customer_id,
  c.customer_name,
  SUM(s.total_amount) AS total_revenue,
  RANK() OVER(ORDER BY SUM(s.total_amount) DESC) AS top_customers
FROM customers c
  JOIN sales s ON c.customer_id = s.customer_id
WHERE s.sale_date BETWEEN '2023-01-01' AND '2023-12-31'
GROUP BY c.customer_id, c.customer_name
)

SELECT
	customer_name,
    top_customers,
    total_revenue
FROM cte 
WHERE top_customers <= 3
